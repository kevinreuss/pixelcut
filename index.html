<!DOCTYPE html>
<html lang="de">
  <head>
    <!-- Hotjar Tracking Code for PixelCut -->
    <script>
      (function (h, o, t, j, a, r) {
        h.hj =
          h.hj ||
          function () {
            (h.hj.q = h.hj.q || []).push(arguments);
          };
        h._hjSettings = { hjid: 5346341, hjsv: 6 };
        a = o.getElementsByTagName("head")[0];
        r = o.createElement("script");
        r.async = 1;
        r.src = t + h._hjSettings.hjid + j + h._hjSettings.hjsv;
        a.appendChild(r);
      })(window, document, "https://static.hotjar.com/c/hotjar-", ".js?sv=");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PixelCut - Einfache Designs f√ºr deinen Lasercutter</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #3498db;
        --primary-dark: #2980b9;
        --secondary: #e74c3c;
        --light: #ecf0f1;
        --dark: #2c3e50;
        --success: #2ecc71;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f9f9f9;
        color: var(--dark);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .container {
        width: 100%;
        margin: 0 auto;
        padding: 0 1rem;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
        font-size: 1.5rem;
        color: var(--primary);
      }

      .logo i {
        font-size: 1.8rem;
      }

      main {
        flex: 1;
        padding: 2rem 0;
      }

      .editor-container {
        display: flex;
        flex-direction: column;
        margin-top: 1.5rem;
        gap: 1.5rem;
      }

      @media (min-width: 768px) {
        .editor-container {
          flex-direction: row;
        }
      }

      .tools-panel {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      @media (min-width: 768px) {
        .tools-panel {
          width: 300px;
        }
      }

      .tools-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background-color: #f9f9f9;
        border-radius: 6px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
        border-bottom: 1px solid #dfe6e9;
        padding-bottom: 0.5rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title::after {
        content: "\f077";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        font-size: 0.8rem;
        transition: transform 0.3s ease;
      }

      .section-title.collapsed::after {
        transform: rotate(180deg);
      }

      .section-content {
        transition: max-height 0.3s ease, opacity 0.3s ease,
          margin-top 0.3s ease;
        max-height: 1000px;
        opacity: 1;
        overflow: hidden;
      }

      .section-content.collapsed {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
      }

      .tool-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .tool-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background-color: var(--light);
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.2rem;
      }

      .tool-btn:hover {
        background-color: #dfe6e9;
      }

      .tool-btn.active {
        border-color: var(--primary);
        background-color: rgba(52, 152, 219, 0.1);
        color: var(--primary);
      }

      .grid-settings {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .setting-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .setting-label {
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .setting-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      input[type="number"] {
        width: 80px;
        padding: 0.5rem;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        width: 100%;
        justify-content: center;
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background-color: var(--primary-dark);
      }

      .btn-success {
        background-color: var(--success);
        color: white;
      }

      .btn-success:hover {
        background-color: #27ae60;
      }

      .btn-dark {
        background-color: var(--dark);
        color: white;
      }

      .btn-dark:hover {
        background-color: #2c3e50;
      }

      .canvas-container {
        flex: 1;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow: hidden;
      }

      .canvas-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .canvas-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .header-menu {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
      }

      @media (max-width: 767px) {
        .canvas-header {
          flex-direction: column;
          align-items: stretch;
        }

        .header-menu {
          justify-content: space-between;
        }

        .btn-sm {
          padding: 0.5rem 0.75rem;
          font-size: 0.85rem;
        }

        .dropdown-toggle::after {
          font-size: 0.7rem;
        }
      }

      #canvas-wrapper {
        flex: 1;
        overflow: auto;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
      }

      canvas {
        background-color: white;
      }

      footer {
        background-color: white;
        padding: 1.5rem 0;
        text-align: center;
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-top: 1.5rem;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      }

      .mobile-warning {
        display: none;
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--secondary);
        padding: 0.75rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        text-align: center;
      }

      @media (max-width: 767px) {
        .mobile-warning {
          display: block;
        }
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 0;
        width: 80%;
        max-width: 800px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        max-height: 80vh;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #dfe6e9;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--dark);
      }

      .close-modal {
        font-size: 1.8rem;
        font-weight: bold;
        color: #7f8c8d;
        cursor: pointer;
      }

      .close-modal:hover {
        color: var(--dark);
      }

      .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
      }

      #svg-preview-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
        border: 1px solid #dfe6e9;
        border-radius: 4px;
        padding: 0.5rem;
        background-color: #f9f9f9;
        overflow: hidden;
      }

      #svg-preview-container svg {
        max-width: 100%;
        max-height: 60vh;
        background-color: white;
        display: block;
        margin: 0 auto;
      }

      .tool-groups {
        display: flex;
        flex-direction: row;
        gap: 4rem;
      }

      .tool-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .tool-group-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #7f8c8d;
        margin-bottom: 0.25rem;
      }

      /* Examples Modal Styles */
      .examples-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .example-card {
        border: 2px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.2s;
        cursor: pointer;
      }

      .example-card.selected {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
      }

      .example-preview {
        width: 100%;
        height: 180px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f9f9f9;
        padding: 1rem;
      }

      .example-info {
        padding: 1rem;
      }

      .example-info h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1.1rem;
        color: var(--dark);
      }

      .example-info p {
        margin: 0;
        font-size: 0.9rem;
        color: #7f8c8d;
      }

      .examples-footer {
        display: flex;
        justify-content: flex-end;
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-toggle::after {
        content: "\f078";
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        font-size: 0.7rem;
        margin-left: 0.5rem;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: white;
        min-width: 180px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1;
        border-radius: 6px;
        overflow: hidden;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 0.9rem;
        color: var(--dark);
      }

      .dropdown-item:hover {
        background-color: #f9f9f9;
      }

      @media (max-width: 767px) {
        .canvas-header {
          flex-direction: column;
          align-items: stretch;
        }

        .header-menu {
          justify-content: space-between;
        }

        .btn-sm {
          padding: 0.5rem 0.75rem;
          font-size: 0.85rem;
        }

        .dropdown-toggle::after {
          font-size: 0.7rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <div class="header-content">
          <div class="logo">
            <i class="fas fa-cut"></i>
            <span>PixelCut</span>
          </div>
        </div>
      </div>
    </header>

    <main class="container">
      <div class="mobile-warning">
        <i class="fas fa-mobile-alt"></i> For the best experience, we recommend
        using this tool on a larger screen.
      </div>

      <div class="editor-container">
        <div class="tools-panel">
          <div class="tools-section">
            <div class="section-title">Grid Settings</div>
            <div class="section-content">
              <div class="grid-settings">
                <div class="setting-group">
                  <div class="setting-label">Grid Size</div>
                  <div class="setting-input">
                    <input
                      type="number"
                      id="grid-width"
                      min="1"
                      max="100"
                      value="20"
                    />
                    x
                    <input
                      type="number"
                      id="grid-height"
                      min="1"
                      max="100"
                      value="20"
                    />
                  </div>
                </div>

                <div class="setting-group">
                  <div class="setting-label">Cell Size (px)</div>
                  <div class="setting-input">
                    <input
                      type="number"
                      id="cell-size"
                      min="10"
                      max="100"
                      value="30"
                    />
                  </div>
                </div>

                <button id="apply-grid" class="btn btn-primary">
                  <i class="fas fa-sync-alt"></i> Apply Grid
                </button>
              </div>
            </div>
          </div>

          <div class="tools-section">
            <div class="section-title">Stay Updated</div>
            <div class="section-content">
              <p class="setting-label" style="margin-bottom: 0.5rem">
                Leave your email and get notified about improvements, bug fixes,
                and new features.
              </p>
              <form
                action="https://formspree.io/f/xaneeblg"
                method="POST"
                class="newsletter-form"
              >
                <div class="setting-group">
                  <div class="setting-label">Your E-Mail:</div>
                  <input
                    type="email"
                    name="email"
                    placeholder="email@example.com"
                    required
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border: 1px solid #dfe6e9;
                      border-radius: 4px;
                      font-size: 0.9rem;
                      margin-bottom: 0.5rem;
                    "
                  />
                </div>
                <div class="setting-group">
                  <div class="setting-label">Message (optional):</div>
                  <textarea
                    name="message"
                    rows="2"
                    placeholder="I want to receive updates..."
                    style="
                      width: 100%;
                      padding: 0.5rem;
                      border: 1px solid #dfe6e9;
                      border-radius: 4px;
                      font-size: 0.9rem;
                      resize: vertical;
                      margin-bottom: 0.5rem;
                    "
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i> Subscribe
                </button>
              </form>
            </div>
          </div>
        </div>

        <div class="canvas-container">
          <div class="canvas-header">
            <div class="tools-section">
              <div class="tool-groups">
                <div class="tool-group">
                  <div class="tool-group-title">Drawing Tools:</div>
                  <div class="tool-buttons">
                    <button
                      id="material-tool"
                      class="tool-btn active"
                      title="Material"
                    >
                      <i class="fas fa-square" style="color: #deb887"></i>
                    </button>
                    <button
                      id="engraving-tool"
                      class="tool-btn"
                      title="Engraving"
                    >
                      <i class="fas fa-burn" style="color: #8b4513"></i>
                    </button>
                    <button id="eraser-tool" class="tool-btn" title="Eraser">
                      <i class="fas fa-eraser"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="header-menu">
              <button
                id="load-example"
                class="btn btn-dark btn-sm"
                style="width: auto"
              >
                <i class="fas fa-lightbulb"></i> Load Example
              </button>

              <div class="dropdown">
                <button class="btn btn-dark btn-sm dropdown-toggle">
                  <i class="fas fa-save"></i> Save/Load
                </button>
                <div class="dropdown-content">
                  <button id="download-json" class="dropdown-item">
                    <i class="fas fa-download"></i> Download State
                  </button>
                  <label for="upload-json" class="dropdown-item">
                    <i class="fas fa-upload"></i> Upload State
                  </label>
                  <input
                    type="file"
                    id="upload-json"
                    accept=".json"
                    style="display: none"
                  />
                </div>
              </div>

              <div class="dropdown">
                <button class="btn btn-success btn-sm dropdown-toggle">
                  <i class="fas fa-file-export"></i> Export
                </button>
                <div class="dropdown-content">
                  <button id="preview-svg" class="dropdown-item">
                    <i class="fas fa-eye"></i> Preview SVG
                  </button>
                  <button id="export-svg" class="dropdown-item">
                    <i class="fas fa-file-export"></i> Export as SVG
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div id="canvas-wrapper">
            <canvas id="grid-canvas"></canvas>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2025 PixelCut - Simple Designs for your Laser Cutter</p>
      </div>
    </footer>

    <!-- SVG Preview Modal -->
    <div id="svg-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>SVG Preview</h2>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div id="svg-preview-container"></div>
        </div>
      </div>
    </div>

    <!-- Examples Modal -->
    <div id="examples-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Load Example</h2>
          <span class="close-examples-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="examples-grid">
            <!-- Examples will be inserted here by JavaScript -->
          </div>
          <div class="examples-footer">
            <button id="load-selected-example" class="btn btn-primary" disabled>
              <i class="fas fa-check"></i> Load Selected Example
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="examples.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Add collapsible functionality to section titles
        const sectionTitles = document.querySelectorAll(".section-title");

        sectionTitles.forEach((title) => {
          title.addEventListener("click", function () {
            // Toggle collapsed class on title
            this.classList.toggle("collapsed");

            // Toggle collapsed class on the content
            const content = this.nextElementSibling;
            content.classList.toggle("collapsed");

            // Save state to localStorage
            saveMenuState();
          });
        });

        // Load menu state from localStorage
        function loadMenuState() {
          const savedState = localStorage.getItem("pixelcutMenuState");

          if (savedState) {
            const collapsedSections = JSON.parse(savedState);

            sectionTitles.forEach((title, index) => {
              if (collapsedSections[index]) {
                title.classList.add("collapsed");
                title.nextElementSibling.classList.add("collapsed");
              }
            });
          }
        }

        // Save menu state to localStorage
        function saveMenuState() {
          const collapsedState = Array.from(sectionTitles).map((title) =>
            title.classList.contains("collapsed")
          );

          localStorage.setItem(
            "pixelcutMenuState",
            JSON.stringify(collapsedState)
          );
        }

        // Load menu state on page load
        loadMenuState();

        // Canvas und Kontext
        const canvas = document.getElementById("grid-canvas");
        const ctx = canvas.getContext("2d");

        // Grid-Einstellungen
        let gridWidth = 20;
        let gridHeight = 20;
        let cellSize = 30;
        let grid = [];

        // Werkzeuge
        const tools = {
          material: document.getElementById("material-tool"),
          engraving: document.getElementById("engraving-tool"),
          eraser: document.getElementById("eraser-tool"),
        };

        let activeTool = "material";
        let isDrawing = false;

        // Holztexturen erstellen
        const woodPattern = document.createElement("canvas");
        const engravingPattern = document.createElement("canvas");

        function createWoodPattern() {
          woodPattern.width = cellSize;
          woodPattern.height = cellSize;
          const wctx = woodPattern.getContext("2d");

          // Grundfarbe (helles Holz)
          wctx.fillStyle = "#deb887";
          wctx.fillRect(0, 0, cellSize, cellSize);

          // Maserung hinzuf√ºgen
          wctx.strokeStyle = "#d2691e";
          wctx.globalAlpha = 0.1;
          for (let i = 0; i < 5; i++) {
            wctx.beginPath();
            wctx.moveTo(0, Math.random() * cellSize);
            wctx.bezierCurveTo(
              cellSize / 3,
              Math.random() * cellSize,
              (2 * cellSize) / 3,
              Math.random() * cellSize,
              cellSize,
              Math.random() * cellSize
            );
            wctx.stroke();
          }
        }

        function createEngravingPattern() {
          engravingPattern.width = cellSize;
          engravingPattern.height = cellSize;
          const ectx = engravingPattern.getContext("2d");

          // Dunklere Grundfarbe
          ectx.fillStyle = "#8b4513";
          ectx.fillRect(0, 0, cellSize, cellSize);

          // Verbrannte Struktur
          ectx.strokeStyle = "#000000";
          ectx.globalAlpha = 0.2;

          // Kreuzschraffur
          for (let i = 0; i < cellSize; i += 3) {
            ectx.beginPath();
            ectx.moveTo(0, i);
            ectx.lineTo(cellSize, i);
            ectx.stroke();

            ectx.beginPath();
            ectx.moveTo(i, 0);
            ectx.lineTo(i, cellSize);
            ectx.stroke();
          }
        }

        // Aus localStorage laden, falls vorhanden
        function loadFromLocalStorage() {
          const savedState = localStorage.getItem("pixelcutState");

          if (savedState) {
            const state = JSON.parse(savedState);

            // Grid-Einstellungen wiederherstellen
            if (state.gridWidth) {
              document.getElementById("grid-width").value = state.gridWidth;
              gridWidth = state.gridWidth;
            }

            if (state.gridHeight) {
              document.getElementById("grid-height").value = state.gridHeight;
              gridHeight = state.gridHeight;
            }

            if (state.cellSize) {
              document.getElementById("cell-size").value = state.cellSize;
              cellSize = state.cellSize;
            }

            // Zeichnung wiederherstellen
            if (state.grid) {
              grid = state.grid;
            }

            // Canvas-Gr√∂√üe anpassen und neu zeichnen
            canvas.width = gridWidth * cellSize;
            canvas.height = gridHeight * cellSize;
            drawGrid();
          }
        }

        // In localStorage speichern
        function saveToLocalStorage() {
          const state = {
            gridWidth,
            gridHeight,
            cellSize,
            grid,
          };

          localStorage.setItem("pixelcutState", JSON.stringify(state));
        }

        // Gespeicherten Zustand laden, falls vorhanden
        loadFromLocalStorage();

        // Wenn kein gespeicherter Zustand vorhanden ist, Grid initialisieren
        if (grid.length === 0) {
          initGrid();
        }

        setupEventListeners();

        // Grid initialisieren
        function initGrid() {
          const newGridWidth = parseInt(
            document.getElementById("grid-width").value
          );
          const newGridHeight = parseInt(
            document.getElementById("grid-height").value
          );
          const newCellSize = parseInt(
            document.getElementById("cell-size").value
          );

          // Altes Grid speichern
          const oldGrid = grid;
          const oldGridWidth = gridWidth;
          const oldGridHeight = gridHeight;
          const oldCellSize = cellSize;

          // Neue Werte √ºbernehmen
          gridWidth = newGridWidth;
          gridHeight = newGridHeight;
          cellSize = newCellSize;

          // Canvas-Gr√∂√üe anpassen
          canvas.width = gridWidth * cellSize;
          canvas.height = gridHeight * cellSize;

          // Neues Grid erstellen mit "void" als Standardwert
          const newGrid = Array(gridHeight)
            .fill()
            .map(() => Array(gridWidth).fill("void"));

          // Vorhandene Zeichnung √ºbernehmen
          if (oldGrid.length > 0) {
            // Gemeinsame H√∂he und Breite bestimmen (kleinerer Wert)
            const commonHeight = Math.min(oldGridHeight, gridHeight);
            const commonWidth = Math.min(oldGridWidth, gridWidth);

            // Daten √ºbertragen und alte true/false Werte konvertieren
            for (let y = 0; y < commonHeight; y++) {
              for (let x = 0; x < commonWidth; x++) {
                newGrid[y][x] = oldGrid[y][x] === true ? "material" : "void";
              }
            }
          }

          // Neues Grid √ºbernehmen
          grid = newGrid;

          // Grid zeichnen
          drawGrid();

          // √Ñnderungen speichern
          saveToLocalStorage();
        }

        // Grid zeichnen
        function drawGrid() {
          // Texturen bei Gr√∂√üen√§nderung neu erstellen
          createWoodPattern();
          createEngravingPattern();

          // Canvas l√∂schen
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Grid-Linien zeichnen
          ctx.strokeStyle = "#dfe6e9";
          ctx.lineWidth = 1;

          // Vertikale Linien
          for (let x = 0; x <= gridWidth; x++) {
            ctx.beginPath();
            ctx.moveTo(x * cellSize, 0);
            ctx.lineTo(x * cellSize, gridHeight * cellSize);
            ctx.stroke();
          }

          // Horizontale Linien
          for (let y = 0; y <= gridHeight; y++) {
            ctx.beginPath();
            ctx.moveTo(0, y * cellSize);
            ctx.lineTo(gridWidth * cellSize, y * cellSize);
            ctx.stroke();
          }

          // Gef√ºllte Zellen zeichnen
          for (let y = 0; y < gridHeight; y++) {
            for (let x = 0; x < gridWidth; x++) {
              if (grid[y][x] === "material") {
                ctx.drawImage(woodPattern, x * cellSize, y * cellSize);
              } else if (grid[y][x] === "engraving") {
                ctx.drawImage(engravingPattern, x * cellSize, y * cellSize);
              }
            }
          }
        }

        // Event-Listener einrichten
        function setupEventListeners() {
          // Grid-Einstellungen anwenden
          document
            .getElementById("apply-grid")
            .addEventListener("click", initGrid);

          // Werkzeug-Buttons
          for (const [toolName, toolButton] of Object.entries(tools)) {
            toolButton.addEventListener("click", () => {
              setActiveTool(toolName);
            });
          }

          // Canvas-Interaktionen
          canvas.addEventListener("mousedown", startDrawing);
          canvas.addEventListener("mousemove", draw);
          canvas.addEventListener("mouseup", stopDrawing);
          canvas.addEventListener("mouseleave", stopDrawing);

          // Touch-Unterst√ºtzung
          canvas.addEventListener("touchstart", handleTouch);
          canvas.addEventListener("touchmove", handleTouch);
          canvas.addEventListener("touchend", stopDrawing);

          // Export-Button in dropdown
          document
            .getElementById("export-svg")
            .addEventListener("click", exportSVG);

          // Preview-Button in dropdown
          document
            .getElementById("preview-svg")
            .addEventListener("click", previewSVG);

          // Modal schlie√üen
          document
            .querySelector(".close-modal")
            .addEventListener("click", closeModal);

          // Examples Modal schlie√üen
          document
            .querySelector(".close-examples-modal")
            .addEventListener("click", closeExamplesModal);

          // Klick au√üerhalb des Modals schlie√üt es
          window.addEventListener("click", function (event) {
            const modal = document.getElementById("svg-modal");
            const examplesModal = document.getElementById("examples-modal");
            if (event.target === modal) {
              closeModal();
            }
            if (event.target === examplesModal) {
              closeExamplesModal();
            }
          });

          // Load Example Button (both in sidebar and header)
          const loadExampleButtons = document.querySelectorAll("#load-example");
          loadExampleButtons.forEach((button) => {
            button.addEventListener("click", showExamplesModal);
          });

          // Download-Button in dropdown
          document
            .getElementById("download-json")
            .addEventListener("click", downloadState);

          // Upload-Input in dropdown
          document
            .getElementById("upload-json")
            .addEventListener("change", uploadState);
        }

        // Aktives Werkzeug setzen
        function setActiveTool(toolName) {
          activeTool = toolName;

          // Alle Buttons zur√ºcksetzen
          for (const button of Object.values(tools)) {
            button.classList.remove("active");
          }

          // Aktiven Button markieren
          tools[toolName].classList.add("active");
        }

        // Zeichnen starten
        function startDrawing(e) {
          isDrawing = true;
          const { x, y } = getCellCoordinates(e);
          updateCell(x, y);
        }

        // Zeichnen
        function draw(e) {
          if (!isDrawing) return;
          const { x, y } = getCellCoordinates(e);
          updateCell(x, y);
        }

        // Zeichnen beenden
        function stopDrawing() {
          isDrawing = false;
        }

        // Touch-Events behandeln
        function handleTouch(e) {
          e.preventDefault();

          const touch = e.touches[0];
          const mouseEvent = new MouseEvent(
            e.type === "touchstart" ? "mousedown" : "mousemove",
            {
              clientX: touch.clientX,
              clientY: touch.clientY,
            }
          );

          canvas.dispatchEvent(mouseEvent);
        }

        // Zellkoordinaten aus Mausposition ermitteln
        function getCellCoordinates(e) {
          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;

          const x = Math.floor(((e.clientX - rect.left) * scaleX) / cellSize);
          const y = Math.floor(((e.clientY - rect.top) * scaleY) / cellSize);

          return { x, y };
        }

        // Zelle aktualisieren
        function updateCell(x, y) {
          // Pr√ºfen, ob Koordinaten im Grid liegen
          if (x < 0 || x >= gridWidth || y < 0 || y >= gridHeight) {
            return;
          }

          // Zelle je nach Werkzeug aktualisieren
          switch (activeTool) {
            case "material":
              grid[y][x] = "material";
              break;
            case "engraving":
              grid[y][x] = "engraving";
              break;
            case "eraser":
              grid[y][x] = "void";
              break;
          }

          // Grid neu zeichnen
          drawGrid();

          // √Ñnderungen speichern
          saveToLocalStorage();
        }

        // SVG exportieren
        function exportSVG() {
          // Separate Pfade f√ºr Material und Engraving erstellen
          const materialPaths = generateOutlinePaths("material");
          const engravingPaths = generateOutlinePaths("engraving");

          // Bounding box f√ºr alle Elemente berechnen
          let minX = gridWidth * cellSize;
          let minY = gridHeight * cellSize;
          let maxX = 0;
          let maxY = 0;

          // Durch alle Zellen iterieren
          for (let y = 0; y < gridHeight; y++) {
            for (let x = 0; x < gridWidth; x++) {
              if (grid[y][x] !== "void") {
                minX = Math.min(minX, x * cellSize);
                minY = Math.min(minY, y * cellSize);
                maxX = Math.max(maxX, (x + 1) * cellSize);
                maxY = Math.max(maxY, (y + 1) * cellSize);
              }
            }
          }

          // Padding hinzuf√ºgen (5px auf jeder Seite)
          const padding = 5;
          minX = Math.max(0, minX - padding);
          minY = Math.max(0, minY - padding);
          maxX = Math.min(gridWidth * cellSize, maxX + padding);
          maxY = Math.min(gridHeight * cellSize, maxY + padding);

          // SVG-Dimensionen berechnen
          const svgWidth = maxX - minX;
          const svgHeight = maxY - minY;

          // SVG erstellen mit viewBox
          let svgContent = `<svg width="${svgWidth}" height="${svgHeight}" viewBox="${minX} ${minY} ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg">`;

          // Material-Pfade mit roter Kontur
          materialPaths.forEach((path) => {
            svgContent += `<path d="${path}" fill="none" stroke="red" stroke-width="1" />`;
          });

          // Engraving-Pfade mit blauer Kontur
          engravingPaths.forEach((path) => {
            svgContent += `<path d="${path}" fill="none" stroke="blue" stroke-width="1" />`;
          });

          svgContent += "</svg>";
          return svgContent;
        }

        // Umrisspfade generieren
        function generateOutlinePaths(type) {
          // Tempor√§res Grid erstellen, das um 1 gr√∂√üer ist (f√ºr Randpr√ºfung)
          const tempGrid = Array(gridHeight + 2)
            .fill()
            .map(() => Array(gridWidth + 2).fill("void"));

          // Daten aus dem eigentlichen Grid kopieren
          for (let y = 0; y < gridHeight; y++) {
            for (let x = 0; x < gridWidth; x++) {
              tempGrid[y + 1][x + 1] = grid[y][x];
            }
          }

          const paths = [];

          // Horizontale Linien finden
          for (let y = 0; y <= gridHeight; y++) {
            let pathSegments = [];
            let isDrawing = false;
            let startX = 0;

            for (let x = 0; x <= gridWidth; x++) {
              // Pr√ºfen, ob hier eine horizontale Linie gezeichnet werden muss
              const cellBelow =
                y < gridHeight ? tempGrid[y + 1][x + 1] === type : false;
              const cellAbove = y > 0 ? tempGrid[y][x + 1] === type : false;

              if (cellBelow !== cellAbove) {
                if (!isDrawing) {
                  isDrawing = true;
                  startX = x;
                }
              } else if (isDrawing) {
                pathSegments.push(
                  `M${startX * cellSize},${y * cellSize} H${x * cellSize}`
                );
                isDrawing = false;
              }
            }

            if (isDrawing) {
              pathSegments.push(
                `M${startX * cellSize},${y * cellSize} H${gridWidth * cellSize}`
              );
            }

            if (pathSegments.length > 0) {
              paths.push(pathSegments.join(" "));
            }
          }

          // Vertikale Linien finden
          for (let x = 0; x <= gridWidth; x++) {
            let pathSegments = [];
            let isDrawing = false;
            let startY = 0;

            for (let y = 0; y <= gridHeight; y++) {
              const cellRight =
                x < gridWidth ? tempGrid[y + 1][x + 1] === type : false;
              const cellLeft = x > 0 ? tempGrid[y + 1][x] === type : false;

              if (cellRight !== cellLeft) {
                if (!isDrawing) {
                  isDrawing = true;
                  startY = y;
                }
              } else if (isDrawing) {
                pathSegments.push(
                  `M${x * cellSize},${startY * cellSize} V${y * cellSize}`
                );
                isDrawing = false;
              }
            }

            if (isDrawing) {
              pathSegments.push(
                `M${x * cellSize},${startY * cellSize} V${
                  gridHeight * cellSize
                }`
              );
            }

            if (pathSegments.length > 0) {
              paths.push(pathSegments.join(" "));
            }
          }

          return paths;
        }

        // SVG Vorschau anzeigen
        function previewSVG() {
          const svgContent = exportSVG();

          // SVG in Container einf√ºgen
          const previewContainer = document.getElementById(
            "svg-preview-container"
          );
          previewContainer.innerHTML = svgContent;

          // Modal √∂ffnen
          document.getElementById("svg-modal").style.display = "block";
        }

        // Modal schlie√üen
        function closeModal() {
          document.getElementById("svg-modal").style.display = "none";
        }

        // SVG herunterladen
        function downloadSVG(svgContent) {
          const blob = new Blob([svgContent], { type: "image/svg+xml" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "pixelcut-design.svg";
          document.body.appendChild(a);
          a.click();

          // Aufr√§umen
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 0);
        }

        // Zustand als JSON herunterladen
        function downloadState() {
          const state = {
            gridWidth,
            gridHeight,
            cellSize,
            grid,
          };

          const jsonString = JSON.stringify(state, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "pixelcut-state.json";
          document.body.appendChild(a);
          a.click();

          // Aufr√§umen
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 0);
        }

        // Zustand aus JSON-Datei laden
        function uploadState(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const state = JSON.parse(e.target.result);

              // Grid-Einstellungen aktualisieren
              if (state.gridWidth) {
                document.getElementById("grid-width").value = state.gridWidth;
                gridWidth = state.gridWidth;
              }

              if (state.gridHeight) {
                document.getElementById("grid-height").value = state.gridHeight;
                gridHeight = state.gridHeight;
              }

              if (state.cellSize) {
                document.getElementById("cell-size").value = state.cellSize;
                cellSize = state.cellSize;
              }

              // Grid aktualisieren
              if (state.grid) {
                grid = state.grid;
              }

              // Canvas-Gr√∂√üe anpassen und neu zeichnen
              canvas.width = gridWidth * cellSize;
              canvas.height = gridHeight * cellSize;
              drawGrid();

              // Im localStorage speichern
              saveToLocalStorage();

              // Datei-Input zur√ºcksetzen
              event.target.value = "";
            } catch (error) {
              alert("Error loading file: " + error.message);
            }
          };

          reader.readAsText(file);
        }

        // Examples Modal anzeigen
        function showExamplesModal() {
          // Examples Grid leeren
          const examplesGrid = document.querySelector(".examples-grid");
          examplesGrid.innerHTML = "";

          let selectedExampleIndex = -1;
          const loadSelectedButton = document.getElementById(
            "load-selected-example"
          );

          // Examples einf√ºgen
          pixelcutExamples.forEach((example, index) => {
            const exampleCard = document.createElement("div");
            exampleCard.className = "example-card";
            exampleCard.dataset.index = index;

            // Vorschau-Container erstellen
            const previewContainer = document.createElement("div");
            previewContainer.className = "example-preview";

            // Vorschau-Canvas erstellen
            const previewCanvas = document.createElement("canvas");
            previewCanvas.width = 200;
            previewCanvas.height = 150;
            const previewCtx = previewCanvas.getContext("2d");

            // Beispiel auf Canvas zeichnen
            drawExamplePreview(previewCtx, example);

            // Titel und Beschreibung
            const exampleInfo = document.createElement("div");
            exampleInfo.className = "example-info";
            exampleInfo.innerHTML = `
              <h3>${example.title}</h3>
              <p>${example.description}</p>
            `;

            // Klick-Handler f√ºr Karte
            exampleCard.addEventListener("click", function () {
              // Alle Karten zur√ºcksetzen
              document.querySelectorAll(".example-card").forEach((card) => {
                card.classList.remove("selected");
              });

              // Diese Karte ausw√§hlen
              exampleCard.classList.add("selected");
              selectedExampleIndex = index;

              // Load-Button aktivieren
              loadSelectedButton.disabled = false;
            });

            // Alles zusammenf√ºgen
            previewContainer.appendChild(previewCanvas);
            exampleCard.appendChild(previewContainer);
            exampleCard.appendChild(exampleInfo);
            examplesGrid.appendChild(exampleCard);
          });

          // Load-Button Event-Handler
          loadSelectedButton.addEventListener("click", function () {
            if (selectedExampleIndex >= 0) {
              loadExample(selectedExampleIndex);
              closeExamplesModal();
            }
          });

          // Modal anzeigen
          document.getElementById("examples-modal").style.display = "block";
        }

        // Beispiel-Vorschau zeichnen
        function drawExamplePreview(ctx, example) {
          const previewWidth = ctx.canvas.width;
          const previewHeight = ctx.canvas.height;

          // Hintergrund
          ctx.fillStyle = "white";
          ctx.fillRect(0, 0, previewWidth, previewHeight);

          // Skalierungsfaktor berechnen
          const scaleX = previewWidth / (example.gridWidth * example.cellSize);
          const scaleY =
            previewHeight / (example.gridHeight * example.cellSize);
          const scale = Math.min(scaleX, scaleY) * 0.9; // 10% Rand

          // Zentrieren
          const offsetX =
            (previewWidth - example.gridWidth * example.cellSize * scale) / 2;
          const offsetY =
            (previewHeight - example.gridHeight * example.cellSize * scale) / 2;

          // Grid zeichnen
          for (let y = 0; y < example.gridHeight; y++) {
            for (let x = 0; x < example.gridWidth; x++) {
              if (example.grid[y][x] === "material") {
                ctx.fillStyle = "#deb887"; // Helles Holz
                ctx.fillRect(
                  offsetX + x * example.cellSize * scale,
                  offsetY + y * example.cellSize * scale,
                  example.cellSize * scale,
                  example.cellSize * scale
                );
              } else if (example.grid[y][x] === "engraving") {
                ctx.fillStyle = "#8b4513"; // Dunkles Holz
                ctx.fillRect(
                  offsetX + x * example.cellSize * scale,
                  offsetY + y * example.cellSize * scale,
                  example.cellSize * scale,
                  example.cellSize * scale
                );
              }
            }
          }

          // Grid-Linien zeichnen
          ctx.strokeStyle = "#dfe6e9";
          ctx.lineWidth = 0.5;

          // Vertikale Linien
          for (let x = 0; x <= example.gridWidth; x++) {
            ctx.beginPath();
            ctx.moveTo(offsetX + x * example.cellSize * scale, offsetY);
            ctx.lineTo(
              offsetX + x * example.cellSize * scale,
              offsetY + example.gridHeight * example.cellSize * scale
            );
            ctx.stroke();
          }

          // Horizontale Linien
          for (let y = 0; y <= example.gridHeight; y++) {
            ctx.beginPath();
            ctx.moveTo(offsetX, offsetY + y * example.cellSize * scale);
            ctx.lineTo(
              offsetX + example.gridWidth * example.cellSize * scale,
              offsetY + y * example.cellSize * scale
            );
            ctx.stroke();
          }
        }

        // Beispiel laden
        function loadExample(index) {
          const example = pixelcutExamples[index];

          // Grid-Einstellungen aktualisieren
          document.getElementById("grid-width").value = example.gridWidth;
          document.getElementById("grid-height").value = example.gridHeight;
          document.getElementById("cell-size").value = example.cellSize;

          // Werte √ºbernehmen
          gridWidth = example.gridWidth;
          gridHeight = example.gridHeight;
          cellSize = example.cellSize;
          grid = JSON.parse(JSON.stringify(example.grid)); // Deep copy

          // Canvas-Gr√∂√üe anpassen und neu zeichnen
          canvas.width = gridWidth * cellSize;
          canvas.height = gridHeight * cellSize;
          drawGrid();

          // Im localStorage speichern
          saveToLocalStorage();
        }

        // Examples Modal schlie√üen
        function closeExamplesModal() {
          document.getElementById("examples-modal").style.display = "none";
        }
      });
    </script>
  </body>
</html>
